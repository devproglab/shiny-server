library(writexl)
library(data.table)
library(pracma)
library(lubridate)
library(xlsx)
library(reshape2)
library(readxl)
library(dplyr)
library(lmtest)
library(plm)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(factoextra)
library(dtwclust)
library(kml)
library(qwraps2)
library(Amelia)
library(stargazer)
library(jtools)
library(interactions)
# define the markup language we are working in.
# options(qwraps2_markup = "latex") is also supported.
options(qwraps2_markup = "markdown")


options(scipen=999)
setwd("C:/Users/ilua/OneDrive/Старое/Документы/Диплом/Data/xlsx")
data<-data.frame(read_excel("regression_dataset.xlsx"))
data$theil <- data$theil*(-1)
data$theil_ext <- data$theil_ext*(-1)
data$theil_int <- data$theil_int*(-1)
data$HHI <- data$HHI*(-1)
data2<-data.frame(read_excel("regression_raw_dataset.xlsx"))
data2$theil <- data$theil*(-1)
data2$theil_ext <- data$theil_ext*(-1)
data2$theil_int <- data$theil_int*(-1)
data2$HHI <- data$HHI*(-1)
corm <- cor(data2[,3:20])
cor.test(data2$exrate_sd, data2$cpi_sd)
# data <- data[,-1]
# data <- data[,-2]
# corr <- cor(data[5:21])
# data <- data[-412,]
AmeliaView()

pspace<-data.frame(read_xlsx("pspace.xlsx"))
pspace$title<-as.factor(pspace$title)

mean_distance <- ddply(pspace, "title", summarise,
                        dist = mean(distance), compl=mean(complexity))
mean_distance <- mean_distance[-22,]

library(RColorBrewer)
# Define the number of colors you want
nb.cols <- 95
mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb.cols)
library(ggrepel)

ggplot(mean_distance, aes(x=dist, y=compl, color=title)) +
  geom_point() + 
  theme(legend.position="none", axis.title=element_text(size=12,face="bold")) +
  labs(x = "Удаленность товарной группы", y = "Сложность товарной группы") +
  xlim(0.7, 1) +
  ylim(0,1.5) +
  geom_text_repel(aes(label = str_wrap(title, width=35)),
                   size=4,
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   max.overlaps = 20,
                   segment.color = 'grey50')


write_xlsx(exstruct, 'ex.xlsx')
# 0. Cluster analysis by Overall Theil

theil <- data.frame(div = data$theil, period = data$period, iso=data$iso)
theil <- dcast(theil, iso ~ period, value.var = c("div"))
row.names(theil) <- theil$iso
theil <- theil[,2:7]
theil <- cld(theil, idAll=unique(as.character(data$iso)), time=c(1,2,3,4,5,6), varNames='Div')
kml(theil)
x11(type = "Xlib")
choice(theil)

theil_clusters <- data.frame(read.csv('theil-C3-1-Clusters.csv', sep=';'))
names(theil_clusters)[1] = 'iso'

data <- left_join(data, theil_clusters, by='iso')
names(data)[21] <- 'theil_cluster'
class(data$theil_cluster)

library(ggplot2)
data$theil_cluster <- as.factor(data$theil_cluster)

knitr::opts_knit$set(dev.args = list(type = "cairo"))
trace(grDevices::png, quote({
  if (missing(type) && missing(antialias)) {
    type <- "cairo-png"
    antialias <- "subpixel"
  }
}), print = FALSE)

ggplot(data, aes(x=theil, y=HHI, shape=theil_cluster, color=theil_cluster)) +
  geom_point() + 
  theme(legend.position="right", axis.title=element_text(size=14,face="bold"), text = element_text(size=14)) +
  scale_shape_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  scale_color_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  labs(x = "Индекс Тейла", y = "Индекс Херфиндаля-Хиршмана")

ggplot(data, aes(x=theil, y=openness, shape=theil_cluster, color=theil_cluster)) +
  geom_point() + 
  theme(legend.position="right", axis.title=element_text(size=14,face="bold"), text = element_text(size=14)) +
  scale_shape_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  scale_color_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  labs(x = "Индекс Тейла", y = "Открытость экономики")

ggplot(data, aes(x=theil, y=complexity, shape=theil_cluster, color=theil_cluster)) +
  geom_point() + 
  theme(legend.position="right", axis.title=element_text(size=14,face="bold"), text = element_text(size=14)) +
  scale_shape_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  scale_color_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  labs(x = "Индекс Тейла", y = "Сложность товаров")

ggplot(data, aes(x=theil, y=growth_sd, shape=theil_cluster, color=theil_cluster)) +
  geom_point() + 
  theme(legend.position="right", axis.title=element_text(size=14,face="bold"), text = element_text(size=14)) +
  scale_shape_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  scale_color_discrete(name = "Степень диверсификации", labels = c("Высокая", "Средняя", "Низкая")) +
  labs(x = "Индекс Тейла", y = "Волатильность темпов роста")

pc_df <- c()
for (i in unique(data$iso)) {
  extract <- data[data$iso==i,]
  pc_change <- c(i,extract$theil[extract$period==1]/extract$theil[extract$period==6])
  pc_df <- rbind(pc_df, pc_change)
  
}

corr <- cor(s[,4:20])
# 0.1 Summary statistics by group

our_summary1 <-
  list("Открытость экономики" =
         list("среднее"       = ~ round(mean(openness),2),
              "медиана"       = ~ round(median(openness),2),
              "стандартное отклонение" = ~ round(sd(openness),2)),
       "Волатильность темпов роста" =
         list("среднее"       = ~ round(mean(growth_sd),2),
              "медиана"       = ~ round(median(growth_sd),2),
              "стандартное отклонение" = ~ round(sd(growth_sd),2)),
              "Индекс Тейла, общий" =
         list("среднее"       = ~ round(mean(theil),2),
              "медиана"       = ~ round(median(theil),2),
              "стандартное отклонение" = ~ round(sd(theil),2)),
       "Индекса Тейла, интенсивный" =
         list("среднее"       = ~ round(mean(theil_int),2),
              "медиана"       = ~ round(median(theil_int),2),
              "стандартное отклонение" = ~ round(sd(theil_int),2)),
       "Индекс Тейла, экстенсивный" =
         list("среднее"       = ~ round(mean(theil_ext),2),
              "медиана"       = ~ round(median(theil_ext),2),
              "стандартное отклонение" = ~ round(sd(theil_ext),2)),
       "Индекс HHI" =
         list("среднее"       = ~ round(mean(HHI),2),
              "медиана"       = ~ round(median(HHI),2),
              "стандартное отклонение" = ~ round(sd(HHI),2)),
       "Сложность товаров" =
         list("среднее"       = ~ round(mean(complexity),2),
              "медиана"       = ~ round(median(complexity),2),
              "стандартное отклонение" = ~ round(sd(complexity),2)),
       "ВВП на душу" =
         list("среднее"       = ~ round(mean(gdp_pc),2),
              "медиана"       = ~ round(median(gdp_pc),2),
              "стандартное отклонение" = ~ round(sd(gdp_pc),2))
)

by_group <- summary_table(dplyr::group_by(data, theil_cluster), our_summary1)
by_group

save(file = 'by_group.RData', by_group)
save(file = 'data.RData', data)


load(file ='data.RData')
s  <- data[(data$theil_cluster==2)|(data$theil_cluster==3),]
s$openness_int <- s$openness * s$theil_int
s$openness_ext <- s$openness * s$theil_ext
s$openness_HHI <- s$openness * s$HHI
s$openness_theil <- s$openness * s$theil

t <- data[(data$theil_cluster==1),] 

corr <- corr(s[,4:20])
# 1. Random Effects Models

# 1.0 Baseline model

baseline_re <- plm(growth_sd ~ 
             openness +
             institutions +
             cpi_sd +
             gov_sd +
             tot_sd +
             finop +
             fdi, 
           data = s,
           index = c("iso", "period"), 
           model = "random",
           random.method='walhus',
           effect = 'twoways')
summary(baseline_re, robust=TRUE)


# 1.1 Div = Theil

re1 <- plm(growth_sd ~ 
             openness + 
             theil +
             openness:theil +
             complexity +
             institutions +
             cpi_sd +
             gov_sd +
             tot_sd +
             finop +
             fdi, 
           data = s,
           index = c("iso", "period"), 
           model = "random",
           random.method='walhus',
           effect = 'twoways')
summary(re1, robust=TRUE)
johnson_neyman(re1, pred = openness, modx = theil, alpha = .05)

# 1.2 Div = Theil Intensive

re2 <- plm(growth_sd ~ 
             openness + 
             theil_int +
             openness:theil_int +
             complexity +
             institutions +
             cpi_sd +
             gov_sd +
             tot_sd +
             finop +
             fdi, 
           data = s,
           index = c("iso", "period"), 
           model = "random",
           random.method='walhus',
           effect = 'twoways')
summary(re2, robust=TRUE)
johnson_neyman(re2, pred = openness, modx = theil_int, alpha = .05)

# 1.3 Div = Theil Extensive

re3 <- plm(growth_sd ~ 
             openness + 
             theil_ext +
             openness:theil_ext +
             complexity +
             institutions +
             cpi_sd +
             gov_sd +
             tot_sd +
             finop +
             fdi, 
           data = s,
           index = c("iso", "period"), 
           model = "random",
           random.method='walhus',
           effect = 'twoways')
summary(re3, robust=TRUE)
johnson_neyman(re3, pred = openness, modx = theil_ext, alpha = .05)


# 1.4 Div = HHI

re4 <- plm(growth_sd ~ 
             openness + 
             HHI +
             openness:HHI +
             complexity +
             institutions +
             cpi_sd +
             gov_sd +
             tot_sd +
             finop +
             fdi, 
           data = s,
           index = c("iso", "period"), 
           model = "random",
           random.method='walhus',
           effect = 'twoways')
summary(re4, robust=TRUE)
johnson_neyman(re4, pred = openness, modx = HHI, alpha = .05)

# 1.5 Tables
stargazer(baseline_re, re1, re2, re3, re4, type='text')

# 2. System GMM Models

# Y <- c()
# for( i in 1:length(mod2$model)){ Y <- c(Y,mod2$model[[i]][,1])}
# Yhat <- mod2$fitted.values[1:length(mod2$fitted.values)]
# cor(Y,Yhat)^2

# 2.0 Baseline model 

baseline <- pgmm(growth_sd ~ 
               lag(growth_sd, 1) +
               openness +
               institutions +
               cpi_sd +
               gov_sd +
               tot_sd +
               finop +
               fdi
                | lag(growth_sd, 1) + lag(openness, 1:2) + lag(fdi, 1) + lag(cpi_sd, 1:2) + lag(gov_sd, 1:2),
             data = s,
             index = c("iso", "period"),
             transformation = "ld",
             collapse = FALSE,
             robust = TRUE,
             time.dummies = TRUE,
             model = 'twostep',
             effect  = 'twoways'
)
summary(baseline)

Y <- c()
for( i in 1:length(baseline$model)){ Y <- c(Y,baseline$model[[i]][,1])}
Yhat <- baseline$fitted.values[1:length(baseline$fitted.values)]
cor(Y,Yhat)^2

# 2.1 Div = Theil

mod1 <- pgmm(growth_sd ~ 
               lag(growth_sd, 1) +
               openness + 
               theil +
               openness:theil +
               openness:tariff +
               openness:complexity +
               tariff +
               complexity +
               institutions +
               cpi_sd +
               gov_sd +
               tot_sd +
               finop +
               fdi | lag(growth_sd, 1) + lag(openness, 1) + lag(tariff, 1) + lag(theil, 2) + lag(cpi_sd, 1) + lag(gov_sd, 1),
             data = s,
             index = c("iso", "period"),
             transformation = "ld",
             collapse = FALSE,
             robust = TRUE,
             time.dummies = FALSE,
             model = 'twosteps',
             effect  = 'twoways'
)
summary(mod1, robust=TRUE)

Y <- c()
for( i in 1:length(mod1$model)){ Y <- c(Y,mod1$model[[i]][,1])}
Yhat <- mod1$fitted.values[1:length(mod1$fitted.values)]
cor(Y,Yhat)^2

# 2.1 Div = Theil Intensive

mod2 <- pgmm(growth_sd ~ 
               lag(growth_sd, 1) +
               openness + 
               theil_int +
               openness:theil_int +
               openness:tariff +
               openness:complexity +
               tariff +
               complexity +
               institutions +
               cpi_sd +
               gov_sd +
               tot_sd +
               finop +
               fdi | lag(growth_sd, 1) + lag(openness, 1)+ lag(fdi, 2) + lag(tariff, 2) + lag(cpi_sd, 1),
             data = s,
             index = c("iso", "period"),
             transformation = "ld",
             collapse = FALSE,
             robust = TRUE,
             time.dummies = FALSE,
             model = 'twosteps',
             effect  = 'twoways'
)
summary(mod2, robust=TRUE)

Y <- c()
for( i in 1:length(mod2$model)){ Y <- c(Y,mod2$model[[i]][,1])}
Yhat <- mod2$fitted.values[1:length(mod2$fitted.values)]
cor(Y,Yhat)^2

# 2.3 Div = Theil Extensive

mod3 <- pgmm(growth_sd ~ 
               lag(growth_sd, 1) +
               openness + 
               theil_ext +
               openness:theil_ext +
               openness:tariff +
               openness:complexity +
               tariff +
               complexity +
               institutions +
               cpi_sd +
               gov_sd +
               tot_sd +
               finop +
               fdi | lag(growth_sd, 1) + lag(openness, 1) + lag(theil_ext, 1) + lag(tariff, 2) + lag(cpi_sd, 1) + lag(gov_sd, 1),
             data = s,
             index = c("iso", "period"),
             transformation = "ld",
             collapse = FALSE,
             robust = TRUE,
             time.dummies = FALSE,
             model = 'twosteps',
             effect  = 'twoways'
)
summary(mod3, robust=TRUE)
Y <- c()
for( i in 1:length(mod3$model)){ Y <- c(Y,mod3$model[[i]][,1])}
Yhat <- mod3$fitted.values[1:length(mod3$fitted.values)]
cor(Y,Yhat)^2


# 2.4 Div = HHI

mod4 <- pgmm(growth_sd ~ 
               lag(growth_sd, 1) +
               openness + 
               HHI +
               openness:HHI +
               openness:tariff +
               openness:complexity +
               tariff +
               complexity +
               institutions +
               cpi_sd +
               gov_sd +
               tot_sd +
               finop +
               fdi | lag(growth_sd, 1) + lag(openness, 1:2) + lag(HHI, 1) + lag(tariff, 1) + lag(cpi_sd, 1),
             data = s,
             index = c("iso", "period"),
             transformation = "ld",
             collapse = FALSE,
             robust = TRUE,
             time.dummies = FALSE,
             model = 'twosteps',
             effect  = 'twoways'
)
summary(mod4, robust=TRUE)
  Y <- c()
for( i in 1:length(mod4$model)){ Y <- c(Y,mod4$model[[i]][,1])}
Yhat <- mod4$fitted.values[1:length(mod4$fitted.values)]
cor(Y,Yhat)^2


# 2.5 Tables
X2 <- c('Wald χ2', '37.03', '8320.93', '441.83', '3364.52', '919.29')
AR1 <- c('AR1 p-value', '0.01', '0.04', '0.07', '0.12', '0.04')
AR2 <- c('AR2 p-value', '0.53', '0.26', '0.6', '0.23', '0.14')
SARG <- c('Sargan p-value', '0.13', '0.35', '0.3', '0.21', '0.33')

lines <- list(X2, AR1, AR2, SARG)
stargazer(baseline, mod1, mod2, mod3, mod4, type='html', out='gmm.html',
          add.lines=lines
          
          )
library("msm")


s[s$tariff<0,'tariff'] <- 0

source('plotter.R')
effects_graph(mod1, s, 'openness', 'openness:theil', -15, 1, 'Индекс Тейла (общий)', 'Влияние открытости на волатильность', 0.005, c(-0.2, 0.7))
effects_graph(mod1, s, 'openness', 'openness:tariff', -1, 27, 'Средний тариф', 'Влияние открытости на волатильность', 0.005)
effects_graph(mod1, s, 'openness', 'openness:complexity', -3, 2, 'Сложность товаров', 'Влияние открытости на волатильность', 0.005)


effects_graph(mod2, s, 'openness', 'openness:theil_int', -8, 1, 'Индекс Тейла (интенсивный)', 'Влияние открытости на волатильность', 0.005, c(-0.1, 1))
effects_graph(mod2, s, 'openness', 'openness:tariff', -1, 27, 'Средний тариф', 'Влияние открытости на волатильность', 0.005)
effects_graph(mod2, s, 'openness', 'openness:complexity', -3, 2, 'Сложность товаров', 'Влияние открытости на волатильность', 0.005)

effects_graph(mod3, s, 'openness', 'openness:theil_ext', -7, 1, 'Индекс Тейла (экстенсивный)', 'Влияние открытости на волатильность', 0.005,c(-0.1, 1))
effects_graph(mod3, s, 'openness', 'openness:tariff', -1, 27, 'Средний тариф', 'Влияние открытости на волатильность', 0.005)
effects_graph(mod3, s, 'openness', 'openness:complexity', -3, 2, 'Сложность товаров', 'Влияние открытости на волатильность', 0.005)

effects_graph(mod4, s, 'openness', 'openness:HHI', -1, 0, 'Индекс HHI', 'Влияние открытости на волатильность', 0.0005, c(-0.2, 0.7))
effects_graph(mod4, s, 'openness', 'openness:tariff', -1, 27, 'Средний тариф', 'Влияние открытости на волатильность', 0.005)
effects_graph(mod4, s, 'openness', 'openness:complexity', -3, 2, 'Сложность товаров', 'Влияние открытости на волатильность', 0.005)

# Russia: plots

data_rus <- s[s$iso=='RUS',]
for (i in data_rus$period) {
  data_rus$period[i] <- paste(1998+i*3,2000+i*3,sep='-')
}
data_rus$period[6] <- '2016-2019'

require(ggplot2)
plot_theil <- ggplot2::ggplot() + ggplot2::geom_path(data = data_rus, ggplot2::aes(x = data_rus$period, y = data_rus$theil, group=1), size=1.5, color='#00bfc4') +
  theme_minimal() + theme(axis.title.x=element_blank(),
                          axis.text.x=element_blank(),
                          axis.ticks.x=element_blank(),
                          panel.grid.minor = element_blank()) + ggplot2::labs(x = '', y = 'Тейл, общий')
plot_theil_int <- ggplot2::ggplot() + ggplot2::geom_path(data = data_rus, ggplot2::aes(x = data_rus$period, y = data_rus$theil_int, group=1), size=1.5, color='#00bfc4') +
  theme_minimal() + theme(axis.title.x=element_blank(),
                          axis.text.x=element_blank(),
                          axis.ticks.x=element_blank(),
                          panel.grid.minor = element_blank())  + ggplot2::labs(x = '', y = 'Тейл, интенсивный') 
plot_theil_ext <- ggplot2::ggplot() + ggplot2::geom_path(data = data_rus, ggplot2::aes(x = data_rus$period, y = data_rus$theil_ext, group=1), size=1.5, color='#00bfc4') +
  theme_minimal() + theme(axis.title.x=element_blank(),
                          axis.text.x=element_blank(),
                          axis.ticks.x=element_blank(), 
                          panel.grid.minor = element_blank())  + ggplot2::labs(x = '', y = 'Тейл, экстенсивный') 
plot_HHI <- ggplot2::ggplot() + ggplot2::geom_path(data = data_rus, ggplot2::aes(x = data_rus$period, y = data_rus$HHI, group=1), size=1.5, color='#00bfc4') +
  theme_minimal() + theme(panel.grid.minor = element_blank()) + ggplot2::labs(x = 'Период', y = 'HHI') 
library('Cairo')
CairoWin()
require(gridExtra)
plot <- grid.arrange(plot_theil, plot_theil_int, plot_theil_ext, plot_HHI, nrow=4)
ggsave(plot, filename = 'Russia_evolution.png', dpi = 300, type = 'cairo',
       width = 8, height = 6, units = 'in')



ggplot(data = data_rus, aes(period, theil)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(color = "steelblue") + 
  labs(title = "New Marvel characters by alignment",
       subtitle = "(limited to characters with more than 100 appearances)",
       y = "Count of new characters", x = "") + 
  facet_grid(align ~ .) 


