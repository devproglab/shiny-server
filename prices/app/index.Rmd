---
title: "Факторный анализ потребительских цен"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme: 
      version: 4
      bootswatch: lumen
      base_font: 
        google: Roboto
      font_scale: 0.95
      spacer: 0rem
    logo : hse-logo.png
    orientation: rows
    vertical_layout: scroll
    css: style.css # custom css styling
---

```{r setup, include=FALSE, message=FALSE}
Sys.setlocale('LC_TIME', 'Russian')

options(encoding = "UTF-8")
library(clock)
# load(file = 'data.RData')
source('functions.R')
labelset <- clock_labels_lookup('ru')[[2]]
labelset <- substr(labelset, 1, nchar(labelset)-1)
labelset[5] <- 'май' 
palette <- adjustcolor(brewer.pal(n = 9, name = 'Set1'), alpha.f=0.6)

hse_green = palette[3]
hse_red   =  palette[1] 
hse_blue  = palette[2] 

prods <- as.list(read_xlsx('data_output/models/model_list.xlsx'))

```

# Column {.sidebar data-width="250"}

```{r input, echo=FALSE}

helpText("Управление дашбордом")

renderUI({ 
  HTML('Комментарии к используемому подходу приведены <a href="https://www.dropbox.com/s/jx5pw87wlzpsfm2/comments.pdf?dl=0">здесь</a>')
})

fluidRow(
  column(12,
         selectInput(inputId = "prod", 
                     label = "Выберите товарную позицию:", 
                     choices = prods[[1]], 
                     selected = prods[[1]][1],
                     selectize=FALSE,
                     multiple=FALSE,
                     size=10,
                     width = '100%'),
  )
)

product <- reactive({
  prod <- input$prod
  return(prod)
})

```

# 

## Row {data-height="40" style="font-size:20px; font-weight:bold;"}

```{r prod_name, echo=FALSE}
renderText({ 
  sub("^(.*),.*$", "\\1", product())
})

```

## Row {data-height="120"}

### value box {data-width =120}

```{r value_price, echo=FALSE}
renderValueBox(
  {
    model_name = product()
    estimated <- loadR(model_name)
    price = round(last(estimated$df[[1]]),2)
    rub <- '\U20BD'
    date = last(index(estimated$df[[1]]))
    label <- paste(day(as.Date(date)), ' ', labelset[month(as.Date(date))], '-', substr(year(as.Date(date)), 3,4), sep='')
    valueBox(tags$p(paste(price, ' ', rub, '/', substr(model_name, regexpr("([^, ]*$)", model_name)[1], stop=nchar(model_name)), sep=''), style = "font-size: 85%;"), icon = "fa-coins", caption = tags$p(paste('Цена, ', label, sep=''), style = "font-size: 85%;" ), color = hse_blue)
    
  }
)

```

### value box2 {data-width =120}

```{r value_mom, echo=FALSE}
renderValueBox(
  {
    model_name = product()
    estimated <- loadR(model_name)
    mom_change = last(estimated$dfmod_unsmoothed[,1])
    date = last(index(estimated$df[[1]]))
    date_prev = nth(index(estimated$df[[1]]), -2)
    label <- paste(day(as.Date(date)), ' ', labelset[month(as.Date(date))], '-', substr(year(as.Date(date)), 3,4), sep='')
    label_prev <- paste(day(as.Date(date_prev)), ' ', labelset[month(as.Date(date_prev))], '-', substr(year(as.Date(date_prev)), 3,4), sep='')
    if (mom_change>0) {
      valueBox(tags$p(paste('+', round(mom_change*100,2), '%, м/м', sep=''), style = "font-size: 85%;"), icon = "fa-arrow-up", caption =  tags$p(paste('Изменение цены, ', label, '/', label_prev), style = "font-size: 85%;"), color = hse_red)
    } else {
      valueBox(tags$p(paste(round(mom_change*100,2), '%, м/м', sep=''), style = "font-size: 85%;"), icon = "fa-arrow-down", caption = tags$p(paste('Изменение цены, ', label, '/', label_prev), style = "font-size: 85%;"), color = hse_green)
    }
  }
)

```

### value box3 {data-width =120}

```{r value_yoy, echo=FALSE}
renderValueBox(
  {
    model_name = product()
    estimated <- loadR(model_name)
    yoy_change = last(estimated$decomp2[,1])
    date = last(index(estimated$decomp2[,1]))
    date_prev = nth(index(estimated$decomp2[,1]), ifelse(estimated$weekly, -53, -13))
    label <- paste(day(as.Date(date)), ' ', labelset[month(as.Date(date))], '-', substr(year(as.Date(date)), 3,4), sep='')
    label_prev <- paste(day(as.Date(date_prev)), ' ', labelset[month(as.Date(date_prev))], '-', substr(year(as.Date(date_prev)), 3,4), sep='')
    
    if (yoy_change>0) {
      valueBox(tags$p(paste('+', round(yoy_change*100,2), '%, г/г', sep=''), style = "font-size: 85%;"), icon = "fa-arrow-up", caption =  tags$p(paste('Изменение цены, ', label, '/', label_prev), style = "font-size: 85%;"), color = hse_red)
    } else {
      valueBox(tags$p(paste(round(yoy_change*100,2), '%, г/г', sep=''), style = "font-size: 85%;"), icon = "fa-arrow_down", caption = tags$p(paste('Изменение цены, ', label, '/', label_prev), style = "font-size: 85%;"), color = hse_green)
    }
  }
)

```

### value box4 {data-width =120}

```{r weight, echo=FALSE}
renderValueBox(
  {
    model_name = product()
    estimated <- loadR(model_name)
    weight = estimated$weight
    valueBox(tags$p(paste(weight, '%', sep=''), style='font-size:85%'), icon = "fa-shopping-basket", caption = tags$p('Вес в ИПЦ', style = "font-size: 85%;"), color = hse_blue)
  }
)

```

## Column {.tabset data-height="800"}

### Изменение розничной цены - г/г

<div class="chart-wrapper">

<div class="chart-block">

```{r price_yoy, echo=FALSE}

plotlyOutput('price_yoy')

output$price_yoy <- renderPlotly({
  
  model_name = product()
  estimated <- loadR(model_name)
  plotdecomp(estimated, yoy=1)

})

```

</div>


<div class="text-block">

На данном графике жирной линией обозначено, как изменилась цена выбранного товара по сравнению с аналогичным периодом предыдущего года. Это изменение раскладывается на влияние отдельных факторов, релевантных для данного рынка. <br>Под <i>инфляцией спроса</i> понимается изменение динамики спроса на товар, а также влияние общеинфляционных тенденций в экономике на изменение его цены.<br>

```{r download_yearly}

downloadLink("download_yearly", "Скачать данные в .xlsx")

output$download_yearly <- downloadHandler(
    filename = function() {
      model_name = product()
      paste(model_name, "_г_г.xlsx", sep="")
    },
    content = function(file) {
      model_name = product()
      estimated <- loadR(model_name)
      data <- data.frame(estimated$decomp2)
      data$date <- as.Date(as.yearmon(rownames(data)))
      data <- data[,c(ncol(data),(1:ncol(data)-1))]
      names(data) <- c('Дата', 'Изменение цены г/г', 'Инфляция спроса', estimated$varlabels, 'Прочие факторы')
      write_xlsx(data, file)
    }
  )

```

В таблице ниже представлено усредненное за весь период наблюдений (с 2015 года) влияние каждого из факторов, включенных в модель, на ценовую динамику.

```{r price_shares2, echo=FALSE}

plotlyOutput('price_shares2')

output$price_shares2 <- renderPlotly({
  
  model_name = product()
  estimated <- loadR(model_name)
  plotshares(estimated)
  
})
```

</div>


</div>


### Изменение розничной цены - м/м

<div class="chart-wrapper">

<div class="chart-block">


```{r price_mom, echo=FALSE}

plotlyOutput('price_mom')

output$price_mom <- renderPlotly({
  
  model_name = product()
  estimated <- loadR(model_name)
  plotdecomp(estimated, yoy=0)
  
})

```

</div>

<div class="text-block">

На данном графике жирной линией обозначено, как изменилась цена выбранного товара по сравнению с предыдущим месяц. Это изменение раскладывается на влияние отдельных факторов, релевантных для данного рынка. <br>Под <i>инфляцией спроса</i> понимается изменение динамики спроса на товар, а также влияние общеинфляционных тенденций в экономике на изменение его цены.
<br>

```{r download_monthly}

downloadLink("download_monthly", "Скачать данные в .xlsx")

output$download_monthly <- downloadHandler(
    filename = function() {
      model_name = product()
      paste(model_name, "_м_м.xlsx", sep="")
    },
    content = function(file) {
      model_name = product()
      estimated <- loadR(model_name)
      data <- data.frame(estimated$decomp)
      data$date <- as.Date(as.yearmon(rownames(data)))
      data <- data[,c(ncol(data),(1:ncol(data)-1))]
      names(data) <- c('Дата', 'Изменение цены м/м', 'Инфляция спроса', estimated$varlabels, 'Сезонность', 'Прочие факторы')
      write_xlsx(data, file)
    }
  )

```
</div>

</div>

### Структура розничной цены

<div class="chart-wrapper">


```{r price_structure, echo=FALSE}

plotlyOutput('price_structure')

output$price_structure <- renderPlotly({
  model_name = product()
  estimated <- loadR(model_name)
  validate(
    need(!is.null(estimated$price_decomp), "Данные по структуре розничной цены данного товара недоступны")
  )
  
  try(plot_price_decomp(estimated))
  
})

```

<div class="text-block">

На данном графике представлена динамика средней цены выбранного товара в разбивке по основным статьям структуры розничной цены (согласно ежегодным данным Росстата).<br>

```{r download_str}

downloadLink("download_str", "Скачать данные в .xlsx")

output$download_str <- downloadHandler(
    filename = function() {
      model_name = product()
      estimated <- loadR(model_name)
      paste(model_name, "_cтруктура.xlsx", sep="")
    },
    content = function(file) {
      model_name = product()
      estimated <- loadR(model_name)
      data <- estimated$price_decomp
      names <- colnames(data)
      data <- data.frame(data)
      data$price <- rowSums(data)
      data$date <- as.Date(as.yearmon(rownames(data)))
      data <- data[,c(ncol(data), (ncol(data)-1), 1:(ncol(data)-2))]
      names(data) <- c('Дата', 'Цена', names)
      write_xlsx(data, file)
    }
  )

```
</div>
</div>
